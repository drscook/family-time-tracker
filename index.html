function doPost(e) {
  try {
    // Get the active spreadsheet
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // Parse the incoming data
    var data = JSON.parse(e.postData.contents);
    
    // Log incoming data for debugging
    Logger.log('Received data: ' + JSON.stringify(data));
    
    // Check if headers exist, if not create them
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(['Entry ID', 'User', 'Task', 'Start Time', 'End Time', 'Duration (hours)', 'Last Updated']);
      Logger.log('Created headers');
    }
    
    // Check if this is an update (entry ID exists in data)
    if (data.entryId) {
      Logger.log('Entry ID found: ' + data.entryId);
      
      // Try to find existing row with this entry ID
      var dataRange = sheet.getDataRange();
      var values = dataRange.getValues();
      var rowFound = false;
      
      for (var i = 1; i < values.length; i++) { // Start at 1 to skip header
        if (String(values[i][0]) === String(data.entryId)) { // Column A has Entry ID
          Logger.log('Updating row ' + (i + 1));
          // Update the existing row
          sheet.getRange(i + 1, 1, 1, 7).setValues([[
            data.entryId,
            data.user,
            data.task,
            data.startTime,
            data.endTime,
            data.duration,
            new Date()
          ]]);
          rowFound = true;
          break;
        }
      }
      
      // If row not found, add new row
      if (!rowFound) {
        Logger.log('Row not found, adding new row');
        sheet.appendRow([
          data.entryId,
          data.user,
          data.task,
          data.startTime,
          data.endTime,
          data.duration,
          new Date()
        ]);
      }
    } else {
      Logger.log('No entry ID, this should not happen');
      // Fallback - add without entry ID
      sheet.appendRow([
        '',
        data.user,
        data.task,
        data.startTime,
        data.endTime,
        data.duration,
        new Date()
      ]);
    }
    
    // Return success
    return ContentService.createTextOutput(JSON.stringify({
      'status': 'success'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('Error: ' + error.toString());
    // Return error
    return ContentService.createTextOutput(JSON.stringify({
      'status': 'error',
      'message': error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput("Time Tracker API is running");
}
